import groovy.json.JsonSlurper

import java.security.MessageDigest
import java.security.NoSuchAlgorithmException
import java.text.DateFormat
import java.text.SimpleDateFormat
import java.util.zip.ZipEntry
import java.util.zip.ZipOutputStream

/**
 * Contains hash methods.
 */
class Hash {
    public static String sha1(final String text) {
        if (text == null) {
            return null;
        }
        MessageDigest md;
        byte[] sha1hash = null;
        try {
            md = MessageDigest.getInstance("SHA-1");
            md.update(text.getBytes("iso-8859-1"), 0, text.length());
            sha1hash = md.digest();
        } catch (NoSuchAlgorithmException | UnsupportedEncodingException e) {
        }
        return sha1hash.encodeHex().toString();
    }
}

/**
 * Post http request: upload file.
 */
public class MultipartUtility {

    private static final String CRLF = "\r\n";
    private static final String CHARSET = "UTF-8";

    private static final int CONNECT_TIMEOUT = 15_000;
    private static final int READ_TIMEOUT = 10_000;

    private final HttpURLConnection mConnection;
    private final OutputStream mOutputStream;
    private final PrintWriter mWriter;
    private final String mBoundary;

    // for log formatting only
    private final URL mUrl;

    public MultipartUtility(final URL url, final String authorization) throws IOException {
        mUrl = url;

        mBoundary = "---------------------------";

        mConnection = (HttpURLConnection) mUrl.openConnection();
        mConnection.setConnectTimeout(CONNECT_TIMEOUT);
        mConnection.setReadTimeout(READ_TIMEOUT);
        mConnection.setRequestMethod("POST");
        if (authorization != null) {
            mConnection.setRequestProperty("Authorization", authorization);
        }
        mConnection.setRequestProperty("Accept-Charset", CHARSET);
        mConnection.setRequestProperty("Content-Type",
                "multipart/form-data; boundary=" + mBoundary);
        mConnection.setUseCaches(false);
        mConnection.setDoInput(true);
        mConnection.setDoOutput(true);

        mOutputStream = mConnection.getOutputStream();
        mWriter = new PrintWriter(new OutputStreamWriter(mOutputStream, CHARSET),
                true);
    }

    public void addFormField(final String name, final String value) {
        mWriter.append("--").append(mBoundary).append(CRLF)
                .append("Content-Disposition: form-data; name=\"").append(name)
                .append("\"").append(CRLF)
                .append("Content-Type: text/plain; charset=").append(CHARSET)
                .append(CRLF).append(CRLF).append(value).append(CRLF);
    }

    public void addFilePart(final String fieldName, final File uploadFile, final String contentType)
            throws IOException {
        final String fileName = uploadFile.getName();
        mWriter.append("--").append(mBoundary).append(CRLF)
                .append("Content-Disposition: form-data; name=\"")
                .append(fieldName).append("\"; filename=\"").append(fileName)
                .append("\"").append(CRLF).append("Content-Type: ")
                .append(contentType).append(CRLF)
                .append("Content-Transfer-Encoding: binary").append(CRLF)
                .append(CRLF);

        mWriter.flush();
        mOutputStream.flush();
        final FileInputStream inputStream = new FileInputStream(uploadFile)
        final byte[] buffer = new byte[4096];
        int bytesRead;
        while ((bytesRead = inputStream.read(buffer)) != -1) {
            mOutputStream.write(buffer, 0, bytesRead);
        }
        mOutputStream.flush();

        mWriter.append(CRLF);
    }

    public void addHeaderField(String name, String value) {
        mWriter.append(name).append(": ").append(value).append(CRLF);
    }

    public String finish() throws IOException {
        mWriter.append(CRLF).append("--").append(mBoundary).append("--")
                .append(CRLF);
        mWriter.close();

        final int status = mConnection.getResponseCode();
        if (status != 200) {
            println("Status " + status)
        }

        final InputStream is = mConnection.getInputStream()
        final ByteArrayOutputStream bytes = new ByteArrayOutputStream();
        final byte[] buffer = new byte[4096];
        int bytesRead;
        while ((bytesRead = is.read(buffer)) != -1) {
            bytes.write(buffer, 0, bytesRead);
        }

        mConnection.disconnect();
        return bytes.toString("UTF-8");
    }
}

/**
 * Zip a folder.
 */
class Zipper {

    private ZipOutputStream mZipFile;

    Zipper(String fileOutPutName) {
        mZipFile = new ZipOutputStream(new FileOutputStream(fileOutPutName))
    }

    void zip(String folderName) {
        println("[Zipper] - Start zip")
        zipInternal(new File(folderName), "")
        mZipFile.close()
        println("[Zipper] - End zip")
    }

    private zipInternal(File folder, String parentName) {
        if (!folder.exists()) {
            return
        }
        folder.eachFile() { file ->
            if (file.isDirectory()) {
                zipInternal(file, parentName + "/" + file.getName() + "/")
            } else {
                mZipFile.putNextEntry(new ZipEntry(parentName + file.getName()))
                def buffer = new byte[1024 * 1024]
                file.withInputStream { i ->
                    def l = i.read(buffer)
                    // check wether the file is empty
                    if (l > 0) {
                        mZipFile.write(buffer, 0, l)
                    }
                }
                mZipFile.closeEntry()
            }
        }
    }
}

/**
 * Gradle task that zip and upload test results.
 */
class Sha1Task extends DefaultTask {

    @Input
    def String mInput

    @TaskAction
    def sha1Test() {
        println("[SHA1] - Start")
        println("[SHA1] - " + mInput + " : " + Hash.sha1(mInput))
        println("[SHA1] - End")
    }
}

/**
 * Gradle task that zip and upload test results.
 */
class SaveTestResultTask extends DefaultTask {

    @Input
    def String mInputDirPath

    @Input
    def String mOutputZipFilePath

    @Input
    def String mPostUrl

    @Input
    def String mPostJsonAuthenticationFilePath

    @TaskAction
    def saveTest() {
        println("[ZipTestResult] - Start")
        new Zipper(mOutputZipFilePath).zip(mInputDirPath)
        println("[ZipTestResult] - End")

        println("[SendTestResult] - Start")
        postFile(mPostUrl, mPostJsonAuthenticationFilePath, mOutputZipFilePath)
        println("[SendTestResult] - End")
    }

    private static String getUserToken(final String username, final String password) {
        final DateFormat df = new SimpleDateFormat("yyyy-MM-dd HH:mm", Locale.US);
        df.setTimeZone(TimeZone.getTimeZone("gmt"));
        final String currentDate = df.format(new Date());

        String authentication = String.format("%s:%s", username, Hash.sha1(Hash.sha1(password) + currentDate));
        return authentication.bytes.encodeBase64().toString();
    }

    private static def postFile(
            final String postUrl,
            final String postJsonAuthenticationFilePath,
            final String outputZipFilePath) {

        final File jsonAuthenticationFile = new File(postJsonAuthenticationFilePath)
        if (!jsonAuthenticationFile.exists()) {
            println("postFile: json !exists at this path '" + postJsonAuthenticationFilePath + "'")
            return
        }
        def json = new JsonSlurper().parseText(jsonAuthenticationFile.text)

        MultipartUtility connection = new MultipartUtility(new URL(postUrl), "Basic " + getUserToken(json.username, json.password));
        connection.addFilePart("file", new File(outputZipFilePath), "application/zip");
        println(connection.finish());
    }
}

class Time {
    public static String getCurrentDate() {
        final DateFormat df = new SimpleDateFormat("yyyy-MM-dd-HH-mm-ss", Locale.US);
        df.setTimeZone(TimeZone.getTimeZone("gmt"));
        return df.format(new Date());
    }
}

/* --- TASK --- */

task sha1(type: Sha1Task) {
    mInput = ""
}

// Main jenkins task
task jenkins(type: SaveTestResultTask, dependsOn: ['jenkinsSpoon']) {
    mInputDirPath = "$buildDir/spoon-custom-report-dir/debug"
    mOutputZipFilePath = "$buildDir/filespace-tests-" + Time.getCurrentDate() + ".zip"
    mPostUrl = "http://mercandalli.com/FileSpace-API/file"
    mPostJsonAuthenticationFilePath = "$rootDir/config/jenkins/authentication.json"
}

task jenkinsSpoon(dependsOn: ['clean', 'spoon']) {

}

task jenkinsunit(dependsOn: ['check', 'test']) {

}